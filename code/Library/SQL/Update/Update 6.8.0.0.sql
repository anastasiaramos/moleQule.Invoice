/* UPDATE 6.8.0.0*/

SET SEARCH_PATH = "COMMON";

UPDATE "Variable" SET "VALUE" = '6.8.0.0' WHERE "NAME" = 'INVOICE_DB_VERSION';

SET SEARCH_PATH = "0001";

ALTER TABLE "Prestamo" ADD COLUMN "N_CUOTAS" bigint DEFAULT 1;
ALTER TABLE "Prestamo" ADD COLUMN "INICIO_PAGO" date;
ALTER TABLE "Prestamo" ADD COLUMN "PERIODO_PAGO" bigint DEFAULT 1;
ALTER TABLE "Prestamo" ADD COLUMN "IMPORTE_CUOTA" numeric(10,2);
ALTER TABLE "Prestamo" DROP COLUMN "TIPO_INTERES";
ALTER TABLE "Prestamo" DROP COLUMN "FORMA_PAGO";
ALTER TABLE "Prestamo" DROP COLUMN "DIA_PAGO";

UPDATE "Prestamo" SET "N_CUOTAS" = 1,  "IMPORTE_CUOTA" = "IMPORTE", "INICIO_PAGO" = "FECHA_VENCIMIENTO", "PERIODO_PAGO" = 1;

UPDATE "Pago" SET "OID_AGENTE" = PG."OID_PRESTAMO"
FROM (	SELECT PG."OID" AS "OID_PAGO" , PR."OID" AS "OID_PRESTAMO"
	FROM "Pago" AS PG
	INNER JOIN "Pago_Operacion" AS PF ON PF."OID_PAGO" = PG."OID"
	INNER JOIN "Prestamo" AS PR ON PR."OID" = PF."OID_OPERACION"
	WHERE PG."TIPO" = 4 AND PG."ESTADO" != 4) AS PG
WHERE "Pago"."OID" = PG."OID_PAGO";

DROP TABLE IF EXISTS "TipoInteres" CASCADE;
CREATE TABLE "TipoInteres" 
( 
	"OID" bigserial  NOT NULL,
	"OID_PRESTAMO" bigint NOT NULL,
	"TIPO_INTERES" numeric(10,2) NOT NULL,
	"FECHA_INICIO" date,
	"FECHA_FIN" date,
	CONSTRAINT PK_TipoInteres PRIMARY KEY ("OID")
) WITHOUT OIDS;

ALTER TABLE "TipoInteres" OWNER TO moladmin;
GRANT ALL ON TABLE "TipoInteres" TO GROUP "MOLEQULE_ADMINISTRATOR";


