/* UPDATE 7.3.0.1 */

SET SEARCH_PATH = "COMMON";

UPDATE "Variable" SET "VALUE" = '7.3.0.1' WHERE "NAME" = 'INVOICE_DB_VERSION';

SET SEARCH_PATH = "0001";

DROP TABLE IF EXISTS "IVEffect" CASCADE;
CREATE TABLE "IVEffect" 
( 
	"OID" bigserial  NOT NULL,
	"OID_COBRO" bigint NOT NULL,
	"FECHA_EMISION" date,
	"VENCIMIENTO" date,
	"ADELANTADO" boolean,
	"GASTOS_ADELANTO" numeric(10,2) DEFAULT 0,
	"GASTOS_DEVOLUCION" numeric(10,2) DEFAULT 0,
	"GASTOS" numeric(10,2) DEFAULT 0,
	"ESTADO" bigint DEFAULT 1,
	"ESTADO_COBRO" bigint DEFAULT 7,
    "SERIAL" bigint DEFAULT 0 NOT NULL,
    "CODIGO" character varying(255),
    "OBSERVACIONES" character varying(255),
	"OID_CUENTA_BANCARIA" bigint DEFAULT 0,
	CONSTRAINT PK_IVEffect PRIMARY KEY ("OID")
) WITHOUT OIDS;

ALTER TABLE "IVEffect" OWNER TO moladmin;
GRANT ALL ON TABLE "IVEffect" TO GROUP "MOLEQULE_ADMINISTRATOR";

INSERT INTO "IVEffect" ("OID_COBRO", "FECHA_EMISION", "VENCIMIENTO", "ADELANTADO", "GASTOS_ADELANTO", "GASTOS_DEVOLUCION", "GASTOS", "ESTADO", "ESTADO_COBRO", "OID_CUENTA_BANCARIA") 
	SELECT CB."OID", CB."FECHA", CB."VENCIMIENTO", FALSE, 0, 0, "GASTOS_BANCARIOS", 1, "ESTADO_COBRO", CB."OID_CUENTA_BANCARIA"
	FROM "IVCharge"  AS CB 
	WHERE CB."MEDIO_PAGO" IN (3, 4) AND CB."TIPO_COBRO" = 1 AND CB."ESTADO" != 4	
	ORDER BY "VENCIMIENTO";
	
UPDATE "IVEffect" SET "SERIAL" = EF."NROW" , "CODIGO" = lpad(cast(EF."NROW" AS varchar), 5, '0')
FROM (SELECT "OID", ROW_NUMBER() OVER (ORDER BY "VENCIMIENTO" ) AS "NROW"
     FROM "IVEffect" 
     WHERE "VENCIMIENTO" BETWEEN '2011-01-01 00:00:00' AND '2011-12-31 23:59:59') AS EF
WHERE "IVEffect"."OID" = EF."OID";

UPDATE "IVEffect" SET "SERIAL" = EF."NROW" , "CODIGO" = lpad(cast(EF."NROW" AS varchar), 5, '0')
FROM (SELECT "OID", ROW_NUMBER() OVER (ORDER BY "VENCIMIENTO" ) AS "NROW"
     FROM "IVEffect" 
     WHERE "VENCIMIENTO" BETWEEN '2012-01-01 00:00:00' AND '2012-12-31 23:59:59') AS EF
WHERE "IVEffect"."OID" = EF."OID";

UPDATE "IVEffect" SET "SERIAL" = EF."NROW" , "CODIGO" = lpad(cast(EF."NROW" AS varchar), 5, '0')
FROM (SELECT "OID", ROW_NUMBER() OVER (ORDER BY "VENCIMIENTO" ) AS "NROW"
     FROM "IVEffect" 
     WHERE "VENCIMIENTO" BETWEEN '2013-01-01 00:00:00' AND '2013-12-31 23:59:59') AS EF
WHERE "IVEffect"."OID" = EF."OID";

UPDATE "IVEffect" SET "SERIAL" = EF."NROW" , "CODIGO" = lpad(cast(EF."NROW" AS varchar), 5, '0')
FROM (SELECT "OID", ROW_NUMBER() OVER (ORDER BY "VENCIMIENTO" ) AS "NROW"
     FROM "IVEffect" 
     WHERE "VENCIMIENTO" >= '2014-01-01 00:00:00') AS EF
WHERE "IVEffect"."OID" = EF."OID";

UPDATE "IVBankLine" SET "TIPO_OPERACION" = 16 , "OID_OPERACION" = MV."OID_EFECTO", "ID_OPERACION" = MV."ID_EFECTO"
FROM (	SELECT MV."OID" AS "OID_MOV_BANCO", EF."OID" AS "OID_EFECTO", EF."CODIGO" AS "ID_EFECTO"
	FROM "IVBankLine" AS MV
	INNER JOIN "IVCharge" AS CB ON CB."OID" = MV."OID_OPERACION" 
		AND CB."MEDIO_PAGO" IN (3,4) 
	INNER JOIN "IVEffect" AS EF ON EF."OID_COBRO" = CB."OID"
	WHERE MV."TIPO_OPERACION" = 1 AND MV."ESTADO" != 4 AND CB."ESTADO" != 4) AS MV
WHERE "IVBankLine"."OID" = MV."OID_MOV_BANCO";

UPDATE "IVBankLine" SET "TIPO_OPERACION" = 17
FROM(
SELECT MV."OID"
FROM "IVBankLine" AS MV
INNER JOIN "IVEffect" AS EF ON EF."OID" = MV."OID_OPERACION"
INNER JOIN "IVCharge" AS CH ON CH."OID" = EF."OID_COBRO"
WHERE MV."TIPO_OPERACION" = 16 
	AND MV."ESTADO" != 4
	AND CH."ESTADO" != 4
	AND CH."GASTOS_BANCARIOS" = -MV."IMPORTE") AS MV
WHERE "IVBankLine"."OID" = MV."OID"
