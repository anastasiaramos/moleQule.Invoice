/* UPDATE 2.1.2.0*/

SET SEARCH_PATH = "COMMON";

ALTER TABLE "Cliente" ADD COLUMN "HISTORIA" text;
INSERT INTO "COMMON"."SecureItem" ("NAME") VALUES ('Movimientos a Bancos');

SET SEARCH_PATH = "0001";

ALTER TABLE "Cobro" ALTER COLUMN "FECHA" TYPE timestamp without time zone;

CREATE TABLE "MovimientoBanco" ( 
	"OID" bigserial  NOT NULL,
	"OID_OPERACION" int8 NOT NULL,
	"TIPO_OPERACION" int8 DEFAULT 0,
	"SERIAL" bigint UNIQUE,
	"CODIGO" varchar(255) UNIQUE,
	"OID_USUARIO" int8,
	"AUDITADO" bool DEFAULT FALSE,
	"OBSERVACIONES" text,
	CONSTRAINT "PK_MovimientoBanco" PRIMARY KEY ("OID")
) WITHOUT OIDS;

ALTER TABLE "MovimientoBanco" OWNER TO moladmin;
GRANT ALL ON TABLE "MovimientoBanco" TO moladmin;
GRANT ALL ON TABLE "MovimientoBanco" TO GROUP "MOLEQULE_ADMINISTRATOR";

INSERT INTO "Privilege" ("OID_USER", "OID_ITEM", "READ", "WRITE") 
	SELECT u."OID", i."OID", FALSE, FALSE FROM "COMMON"."User" AS u, "COMMON"."SecureItem" AS i
	WHERE (u."OID", i."OID") NOT IN (SELECT "OID_USER", "OID_ITEM" FROM "Privilege");	
	
TRUNCATE TABLE "MovimientoBanco";

ALTER TABLE "MovimientoBanco" ADD COLUMN "FECHA" timestamp without time zone;
	
INSERT INTO "MovimientoBanco" ("OID_OPERACION", "TIPO_OPERACION", "SERIAL", "CODIGO", "FECHA") 
	SELECT "OID", 1, ROW_NUMBER() OVER (ORDER BY "FECHA", "ID_COBRO") + 1000 AS "NROW", trim(to_char(ROW_NUMBER() OVER (ORDER BY "FECHA", "ID_COBRO") + 1000, '000000')), "FECHA"
	FROM "Cobro" 
	WHERE "OID" NOT IN (SELECT "OID_OPERACION" FROM "MovimientoBanco" WHERE "TIPO_OPERACION" = 1)
	AND "OID_CUENTA_BANCARIA" != 0
	ORDER BY "CODIGO";

INSERT INTO "MovimientoBanco" ("OID_OPERACION", "TIPO_OPERACION", "SERIAL", "CODIGO", "FECHA") 
	SELECT "OID", 3, ROW_NUMBER() OVER (ORDER BY "FECHA", "ID_PAGO") + 1220 AS "NROW", trim(to_char(ROW_NUMBER() OVER (ORDER BY "FECHA", "ID_PAGO") + 1220, '000000')), "FECHA"
	FROM "Pago" 
	WHERE "OID" NOT IN (SELECT "OID_OPERACION" FROM "MovimientoBanco" WHERE "TIPO_OPERACION" = 1)
	AND "OID_CUENTA_BANCARIA" != 0		
	ORDER BY "CODIGO";

INSERT INTO "MovimientoBanco" ("OID_OPERACION", "TIPO_OPERACION", "SERIAL", "CODIGO", "FECHA") 
	SELECT "OID", 2, ROW_NUMBER() OVER (ORDER BY "FECHA", "CODIGO") + 1362 AS "NROW", trim(to_char(ROW_NUMBER() OVER (ORDER BY "FECHA", "CODIGO") + 1362, '000000')), "FECHA"
	FROM "LineaCaja" 
	WHERE "OID" NOT IN (SELECT "OID_OPERACION" FROM "MovimientoBanco" WHERE "TIPO_OPERACION" = 1)
	AND "OID_CUENTA_BANCARIA" != 0
	ORDER BY "CODIGO";

UPDATE "MovimientoBanco" SET "SERIAL" = MV."NROW", "CODIGO" = trim(to_char(MV."NROW", '000000'))
FROM (SELECT "OID", ROW_NUMBER() OVER (ORDER BY "FECHA") AS "NROW"
     FROM "MovimientoBanco" 
     ORDER BY "FECHA") AS MV
WHERE "MovimientoBanco"."OID" = MV."OID";

ALTER TABLE "MovimientoBanco" DROP COLUMN "FECHA";
