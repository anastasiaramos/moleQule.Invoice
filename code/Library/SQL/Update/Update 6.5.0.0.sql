/* UPDATE 6.5.0.0*/

SET SEARCH_PATH = "COMMON";

UPDATE "Variable" SET "VALUE" = '6.5.0.0' WHERE "NAME" = 'INVOICE_DB_VERSION';

SET SEARCH_PATH = "0001";

--PAGOS CON TARJETA DE CRÉDITO CON MOVIMIENTO BANCARIO DEL PAGO QUE NO DEBERÍA EXISTIR
UPDATE "MovimientoBanco" SET "ESTADO" = 4 WHERE "OID" IN (
SELECT MV."OID"
FROM "MovimientoBanco" AS MV	
INNER JOIN "Pago" AS PG ON PG."OID" = MV."OID_OPERACION"
INNER JOIN "TarjetaCredito" AS TC ON TC."OID" = PG."OID_TARJETA_CREDITO"
WHERE MV."FECHA" BETWEEN '01/01/0001 00:00:00' AND '12/31/9999 23:59:59' 
	AND MV."ESTADO" != 4 
	AND MV."TIPO_OPERACION" != 10
	AND PG."MEDIO_PAGO" = 8
	AND TC."TIPO" = 1
ORDER BY MV."FECHA", MV."CODIGO");

--DESCUADRE EN EXTRACTOS DEL BANCO
UPDATE "MovimientoBanco" SET "IMPORTE" =  X."IMPORTE"
FROM
(
	SELECT "IMPORTE","APUNTE_BANCARIO", SUM("EXTRACTO") AS "EXTRACTO", "FECHA_EXTRACTO", "OID_TARJETA"
	FROM(
		SELECT COALESCE(SUM(-PG."IMPORTE" - PG."GASTOS_BANCARIOS"),0) AS "IMPORTE"
			,MV."CODIGO" AS "APUNTE_BANCARIO"
			,MV."IMPORTE" AS "EXTRACTO"
			,CAST(MV."FECHA" AS DATE) AS "FECHA_EXTRACTO"
			,COALESCE(TC."NOMBRE" || ' ' || TC."NUMERACION"  , '') AS "TARJETA"
			,MV."OID" AS "OID_MOVIMIENTO"
			,COALESCE(TC."OID", 0) AS "OID_TARJETA"
		FROM "MovimientoBanco" AS MV
		LEFT JOIN "Pago" AS PG ON MV."OID_OPERACION" = PG."OID_TARJETA_CREDITO" 
			AND PG."VENCIMIENTO" = CAST(MV."FECHA" AS DATE) AND PG."MEDIO_PAGO" = 8	AND PG."ESTADO" != 4
			
		LEFT JOIN "TarjetaCredito" AS TC ON TC."OID" = PG."OID_TARJETA_CREDITO" AND TC."TIPO" = 1
		WHERE MV."ESTADO" != 4
			AND MV."TIPO_OPERACION" = 10
			AND TC."TIPO" = 1
		GROUP BY PG."OID_TARJETA_CREDITO", PG."VENCIMIENTO", MV."CODIGO", MV."IMPORTE", MV."FECHA", TC."NOMBRE", TC."NUMERACION", TC."OID", TC."P_COMISION", MV."OID"
		ORDER BY "FECHA_EXTRACTO","APUNTE_BANCARIO", TC."OID"
	)AS Y
	GROUP BY "APUNTE_BANCARIO", "FECHA_EXTRACTO", "OID_TARJETA", "IMPORTE"
	ORDER BY "FECHA_EXTRACTO", "APUNTE_BANCARIO"
) AS X
WHERE "MovimientoBanco"."TIPO_OPERACION" = 10 
	AND  "MovimientoBanco"."ESTADO" != 4 
	AND X."IMPORTE" != X."EXTRACTO"
	AND X."APUNTE_BANCARIO" = "MovimientoBanco"."CODIGO" 
	AND X."FECHA_EXTRACTO" = CAST("MovimientoBanco"."FECHA" AS DATE) 
	AND "MovimientoBanco"."OID_OPERACION" = X."OID_TARJETA";

ALTER TABLE "Traspaso" ADD COLUMN "FECHA_RECEPCION" timestamp without time zone;
UPDATE "Traspaso" SET "FECHA_RECEPCION" = "FECHA";



